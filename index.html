<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Centres Carglass Beta - Style Google Maps</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            height: 100%;
            width: 100%;
        }
        #map-container {
            position: relative;
            height: 100%;
            width: 100%;
        }
        #map { 
            height: 100%;
            width: 100%;
        }
        #search-container {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            width: 400px;
        }
        #search-box {
            background: white;
            border-radius: 24px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            padding: 10px 15px;
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .search-input-container {
            display: flex;
            align-items: center;
            flex-grow: 1;
            position: relative;
        }
        .search-input-container i {
            margin-right: 10px;
            color: #5f6368;
        }
        .search-input {
            flex-grow: 1;
            border: none;
            font-size: 16px;
            outline: none;
        }
        #directions-button, #swap-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #1a73e8;
            margin-left: 10px;
        }
        #destination-container {
            display: none;
        }
        #route-summary {
            display: none;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            padding: 10px 15px;
            margin-top: 10px;
            position: relative;
        }
        #route-summary h3 {
            margin: 0 0 10px;
            font-size: 18px;
            color: #1a73e8;
        }
        #route-summary p {
            margin: 5px 0;
        }
        #close-summary {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #5f6368;
        }
        .leaflet-bottom .leaflet-control-zoom {
            margin-bottom: 40px;
        }
        .leaflet-right .leaflet-control-zoom {
            margin-right: 10px;
        }
        .autocomplete-items {
            position: absolute;
            border: 1px solid #d4d4d4;
            border-bottom: none;
            border-top: none;
            z-index: 99;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #fff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        .autocomplete-item {
            padding: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }
        .autocomplete-item:hover {
            background-color: #f1f3f4;
        }
        .autocomplete-icon {
            margin-right: 10px;
            color: #5f6368;
        }
        .autocomplete-main-text {
            font-weight: 500;
        }
        .autocomplete-secondary-text {
            font-size: 0.9em;
            color: #5f6368;
        }
        .leaflet-popup-content-wrapper {
            background-color: white;
            color: #333;
            border-radius: 4px;
            padding: 1px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
        }
        .leaflet-popup-content {
            margin: 13px 19px;
            line-height: 1.4;
        }
        .leaflet-popup-tip-container {
            display: none;
        }
        .route-info-popup .leaflet-popup-content-wrapper {
            background-color: white;
            color: #1a73e8;
            border-radius: 4px;
            padding: 5px 10px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
            font-size: 12px;
            line-height: 1.2;
            width: auto !important;
        }
        .route-info-popup .leaflet-popup-content {
            margin: 6px 8px;
            display: flex;
            align-items: center;
        }
        .route-info-popup .leaflet-popup-tip {
            background-color: white;
        }
        .route-info {
            display: flex;
            flex-direction: column;
            margin-left: 10px;
        }
        .duration {
            font-size: 14px;
            font-weight: 500;
        }
        .distance {
            font-size: 12px;
            color: #5f6368;
        }
        .route-info-popup i {
            font-size: 20px;
        }
        .route-info-popup .leaflet-popup-close-button {
            color: #1a73e8;
            font-size: 18px;
            padding: 4px 4px 0 0;
        }
        .route-info-popup .leaflet-popup-close-button:hover {
            color: #174ea6;
        }
        #add-waypoint-button {
            background: none;
            border: none;
            color: #1a73e8;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            padding: 5px 10px;
        }
        #add-waypoint-button:hover {
            background-color: #f1f3f4;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="search-container">
            <div id="search-box">
                <div class="search-input-container">
                    <i class="fas fa-search"></i>
                    <input type="text" id="start-input" class="search-input" placeholder="Point de départ">
                </div>
                <button id="directions-button"><i class="fas fa-directions"></i></button>
            </div>
            <div id="destination-container">
                <div id="search-box">
                    <div class="search-input-container">
                        <i class="fas fa-map-marker-alt"></i>
                        <input type="text" id="end-input" class="search-input" placeholder="Point d'arrivée">
                    </div>
                    <button id="swap-button"><i class="fas fa-exchange-alt"></i></button>
                </div>
                <button id="add-waypoint-button"><i class="fas fa-plus"></i> Ajouter un arrêt</button>
            </div>
            <div id="route-summary">
                <button id="close-summary"><i class="fas fa-times"></i></button>
                <h3>Résumé de l'itinéraire</h3>
                <div id="summary-content"></div>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const API_KEY = '5b3ce3597851110001cf62480c9a6e86f751478291620b14c07609af';
            const map = L.map('map', { 
                zoomControl: false,
                zoomSnap: 0.1,
                zoomDelta: 0.1,
                wheelDebounceTime: 0,
                wheelPxPerZoomLevel: 120,
                trackResize: true
            }).setView([46.603354, 1.888334], 6);
            
            // Utilisation d'une couche de tuiles Google Maps avec des paramètres améliorés
            const googleTiles = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                attribution: '© Google Maps',
                tileSize: 256,
                zoomOffset: 0,
                updateWhenIdle: false,
                updateWhenZooming: true,
                updateInterval: 200,
                keepBuffer: 2
            }).addTo(map);

            L.control.zoom({ position: 'bottomright' }).addTo(map);

            // Fonction pour forcer la mise à jour des tuiles
            function updateTiles() {
                googleTiles.redraw();
            }

            // Événements pour déclencher la mise à jour des tuiles
            map.on('zoomend', updateTiles);
            map.on('moveend', updateTiles);

            let currentRoute = null;
            let routeInfoPopup;
            const startInput = document.getElementById('start-input');
            const endInput = document.getElementById('end-input');
            const destinationContainer = document.getElementById('destination-container');
            const routeSummary = document.getElementById('route-summary');
            const summaryContent = document.getElementById('summary-content');
            let selectedStart = null;
            let selectedEnd = null;
            let waypoints = [];

            const landmarks = [
                {name: "ABBEVILLE", address: "31 RTE D'AMIENS", postalCode: "80100", city: "ABBEVILLE", lat: 50.105508, lon: 1.847757, color: 'blue'},
  {name: "AGDE", address: "boulevard Maurice Pacull CC Espace Grand Cap", postalCode: "34300", city: "AGDE", lat: 50.795333, lon: 1.87991, color: 'blue'},
  {name: "AGEN", address: "ZONE COMMERCIALE AGEN SUD RUE DE BELLILE", postalCode: "47000", city: "AGEN", lat: 44.184209, lon: 0.615943, color: 'blue'},
  {name: "AIRE SUR LA LYS", address: "Rue d'Isbergues Centre Cial Carrefour", postalCode: "62120", city: "AIRE SUR LA LYS", lat: 50.638493, lon: 2.405315, color: 'blue'},
  {name: "AIRE SUR L'ADOUR", address: "43 CHEMIN DE CLAVERIE", postalCode: "40800", city: "AIRE SUR L'ADOUR", lat: 43.737172, lon: -0.26742, color: 'blue'},
  {name: "AIX LES BAINS", address: "90 ALLEE DES ERABLES ZONE COMMERCIALE LECLERC", postalCode: "73420", city: "73420 DRUMETTAZ - CLARAFOND", lat: 45.658649, lon: 5.912116, color: 'blue'},
  {name: "AIX LES MILLES", address: "330 RUE GUILLAUME DU VAIR ZA LA PIOLINE", postalCode: "13290", city: "AIX EN PROVENCE", lat: 43.50789, lon: 5.403897, color: 'blue'},
                // Ajoutez le reste de vos landmarks ici avec leurs couleurs spécifiques
            ];

            function getIcon(color) {
                return L.icon({
                    iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
                    iconSize: [25, 41],
                    iconAnchor: [12, 41]
                });
            }

            const markers = landmarks.map(landmark => {
                const marker = L.marker([landmark.lat, landmark.lon], { icon: getIcon(landmark.color) });
                marker.bindPopup(`
                    <strong>${landmark.name}</strong><br>
                    ${landmark.address}<br>
                    ${landmark.postalCode} ${landmark.city}
                `, { offset: [0, -20], autoPan: false });
                marker.on('click', () => onMarkerClick(landmark, marker));
                marker.addTo(map);
                return marker;
            });

            function onMarkerClick(landmark, marker) {
                if (!selectedStart) {
                    selectStart(landmark, marker);
                } else if (!selectedEnd) {
                    selectEnd(landmark, marker);
                } else {
                    resetRoute();
                    selectStart(landmark, marker);
                }
            }

            function selectStart(landmark, marker) {
                selectedStart = landmark;
                startInput.value = landmark.name;
                destinationContainer.style.display = 'block';
                endInput.focus();
                marker.openPopup();
            }

            function selectEnd(landmark, marker) {
                selectedEnd = landmark;
                endInput.value = landmark.name;
                marker.openPopup();
                calculateRoute();
            }

            async function fetchRoute(start, end, waypoints = '') {
                const waypointsParam = waypoints ? `&via=${waypoints}` : '';
                const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${API_KEY}&start=${start}&end=${end}${waypointsParam}`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP! statut: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('Erreur lors de la récupération de l\'itinéraire:', error);
                    throw error;
                }
            }

            async function calculateRoute() {
                if (!selectedStart || !selectedEnd) return;

                const start = `${selectedStart.lon},${selectedStart.lat}`;
                const end = `${selectedEnd.lon},${selectedEnd.lat}`;

                const waypointsString = waypoints.map(wp => `${wp.lon},${wp.lat}`).join('|');

                try {
                    const data = await fetchRoute(start, end, waypointsString);
                    
                    if (currentRoute) {
                        map.removeLayer(currentRoute);
                    }
                    
                    const coords = data.features[0].geometry.coordinates;
                    const latLngs = coords.map(coord => [coord[1], coord[0]]);
                    currentRoute = L.polyline(latLngs, {
                        color: '#1a73e8',
                        weight: 5,
                        opacity: 0.7
                    }).addTo(map);

                    const bounds = currentRoute.getBounds();
                    map.fitBounds(bounds, {
                        padding: [50, 50],
                        maxZoom: 12
                    });

                    updateRouteSummary(data);
                    updateRouteInfoPopup(data, latLngs);

                } catch (error) {
                    console.error("Erreur lors du calcul de l'itinéraire:", error);
                }
            }

            function updateRouteSummary(data) {
                const distance = (data.features[0].properties.summary.distance / 1000).toFixed(1);
                const durationMinutes = Math.round(data.features[0].properties.summary.duration / 60);
                const hours = Math.floor(durationMinutes / 60);
                const minutes = durationMinutes % 60;

                summaryContent.innerHTML = `
                    <p><strong>Départ:</strong> ${selectedStart.name}</p>
                    <p><strong>Arrivée:</strong> ${selectedEnd.name}</p>
                    ${waypoints.map((wp, index) => `<p><strong>Arrêt ${index + 1}:</strong> ${wp.name}</p>`).join('')}
                    <p><strong>Distance:</strong> ${distance} km</p>
                    <p><strong>Durée estimée:</strong> ${hours}h ${minutes}min</p>
                `;

                routeSummary.style.display = 'block';
            }

            function updateRouteInfoPopup(data, latLngs) {
                if (routeInfoPopup) {
                    map.removeLayer(routeInfoPopup);
                }

                const distance = (data.features[0].properties.summary.distance / 1000).toFixed(1);
                const durationMinutes = Math.round(data.features[0].properties.summary.duration / 60);
                const hours = Math.floor(durationMinutes / 60);
                const minutes = durationMinutes % 60;

                routeInfoPopup = L.popup({
                    className: 'route-info-popup',
                    offset: [0, -10],
                    autoClose: false,
                    closeOnClick: false,
                    closeButton: true
                })
                .setLatLng(latLngs[Math.floor(latLngs.length / 2)])
                .setContent(`
                    <i class="fas fa-car"></i>
                    <div class="route-info">
                        <div class="duration">${hours}h ${minutes}min</div>
                        <div class="distance">${distance} km</div>
                    </div>
                `)
                .openOn(map);

                routeInfoPopup.on('remove', function() {
                    // Ne supprime pas l'itinéraire lorsque le popup est fermé
                });
            }

            function resetRoute() {
                if (currentRoute) {
                    map.removeLayer(currentRoute);
                    currentRoute = null;
                }
                if (routeInfoPopup) {
                    map.removeLayer(routeInfoPopup);
                }
                selectedStart = null;
                selectedEnd = null;
                waypoints = [];
                startInput.value = '';
                endInput.value = '';
                destinationContainer.style.display = 'none';
                routeSummary.style.display = 'none';
                
                // Supprimer tous les champs de waypoint
                const waypointInputs = document.querySelectorAll('[id^="waypoint-"]');
                waypointInputs.forEach(input => input.parentNode.parentNode.remove());
            }

            function selectLandmark(landmark, inputId) {
                const marker = markers.find(m => m._latlng.lat === landmark.lat && m._latlng.lng === landmark.lon);
                if (inputId === 'start-input') {
                    selectStart(landmark, marker);
                } else if (inputId === 'end-input') {
                    selectEnd(landmark, marker);
                } else if (inputId.startsWith('waypoint-')) {
                    const index = parseInt(inputId.split('-')[1]);
                    waypoints[index] = landmark;
                }
                if (selectedStart && selectedEnd) {
                    calculateRoute();
                }
            }

            function addWaypoint() {
                const waypointIndex = waypoints.length;
                const waypointInput = document.createElement('input');
                waypointInput.type = 'text';
                waypointInput.id = `waypoint-${waypointIndex}`;
                waypointInput.className = 'search-input';
                waypointInput.placeholder = `Arrêt ${waypointIndex + 1}`;
                
                const waypointContainer = document.createElement('div');
                waypointContainer.id = `search-box`;
                waypointContainer.innerHTML = `
                    <div class="search-input-container">
                        <i class="fas fa-map-pin"></i>
                    </div>
                `;
                waypointContainer.querySelector('.search-input-container').appendChild(waypointInput);
                
                destinationContainer.insertBefore(waypointContainer, document.getElementById('add-waypoint-button'));
                
                autocomplete(waypointInput);
                
                waypoints.push(null);
            }

            function autocomplete(inp) {
                let currentFocus;
                inp.addEventListener("input", function(e) {
                    const val = this.value;
                    closeAllLists();
                    if (!val) { return false; }
                    currentFocus = -1;

                    const a = document.createElement("DIV");
                    a.setAttribute("id", this.id + "autocomplete-list");
                    a.setAttribute("class", "autocomplete-items");
                    this.parentNode.appendChild(a);

                    const matchingLandmarks = landmarks.filter(landmark => 
                        landmark.name.toLowerCase().includes(val.toLowerCase()) ||
                        landmark.address.toLowerCase().includes(val.toLowerCase()) ||
                        landmark.postalCode.includes(val) ||
                        landmark.city.toLowerCase().includes(val.toLowerCase())
                    );

                    matchingLandmarks.forEach((landmark, index) => {
                        const b = document.createElement("DIV");
                        b.classList.add("autocomplete-item");
                        b.innerHTML = `
                            <i class="fas fa-map-marker-alt autocomplete-icon"></i>
                            <div>
                                <div class="autocomplete-main-text">${highlightMatch(landmark.name, val)}</div>
                                <div class="autocomplete-secondary-text">${highlightMatch(landmark.address, val)}, ${highlightMatch(landmark.postalCode, val)} ${highlightMatch(landmark.city, val)}</div>
                            </div>
                        `;
                        b.addEventListener("click", function(e) {
                            inp.value = landmark.name;
                            closeAllLists();
                            selectLandmark(landmark, inp.id);
                        });
                        a.appendChild(b);
                    });
                });

                inp.addEventListener("keydown", function(e) {
                    let x = document.getElementById(this.id + "autocomplete-list");
                    if (x) x = x.getElementsByClassName("autocomplete-item");
                    if (e.keyCode == 40) {
                        currentFocus++;
                        addActive(x);
                    } else if (e.keyCode == 38) {
                        currentFocus--;
                        addActive(x);
                    } else if (e.keyCode == 13) {
                        e.preventDefault();
                        if (currentFocus > -1) {
                            if (x) x[currentFocus].click();
                        } else {
                            selectLandmarkByName(this.value, this.id);
                        }
                    }
                });

                function addActive(x) {
                    if (!x) return false;
                    removeActive(x);
                    if (currentFocus >= x.length) currentFocus = 0;
                    if (currentFocus < 0) currentFocus = (x.length - 1);
                    x[currentFocus].classList.add("autocomplete-active");
                }

                function removeActive(x) {
                    for (let i = 0; i < x.length; i++) {
                        x[i].classList.remove("autocomplete-active");
                    }
                }
            }

            function closeAllLists(elmnt) {
                const x = document.getElementsByClassName("autocomplete-items");
                for (let i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != startInput && elmnt != endInput) {
                        x[i].parentNode.removeChild(x[i]);
                    }
                }
            }

            function selectLandmarkByName(name, inputId) {
                const landmark = landmarks.find(l => l.name.toLowerCase() === name.toLowerCase());
                if (landmark) {
                    selectLandmark(landmark, inputId);
                }
                closeAllLists();
            }

            function highlightMatch(text, query) {
                const regex = new RegExp(`(${query})`, 'gi');
                return text.replace(regex, '<strong>$1</strong>');
            }

            autocomplete(startInput);
            autocomplete(endInput);

            document.getElementById('directions-button').addEventListener('click', function() {
                destinationContainer.style.display = destinationContainer.style.display === 'none' ? 'block' : 'none';
            });

            document.getElementById('close-summary').addEventListener('click', resetRoute);

            document.getElementById('swap-button').addEventListener('click', function() {
                const tempStart = selectedStart;
                const tempStartInput = startInput.value;
                selectedStart = selectedEnd;
                startInput.value = endInput.value;
                selectedEnd = tempStart;
                endInput.value = tempStartInput;
                if (selectedStart && selectedEnd) {
                    calculateRoute();
                }
            });

            document.getElementById('add-waypoint-button').addEventListener('click', addWaypoint);

            map.on('click', function(e) {
                if (e.originalEvent.target.classList.contains('leaflet-container')) {
                    resetRoute();
                }
            });

            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });

            // Nouvelle fonction pour le zoom fluide
            function smoothZoom(map, delta, duration) {
                const startZoom = map.getZoom();
                const targetZoom = Math.min(Math.max(startZoom + delta, 0), 20);
                const startTime = performance.now();

                function easeOutQuad(t) {
                    return t * (2 - t);
                }

                function animate(currentTime) {
                    const elapsedTime = currentTime - startTime;
                    const progress = Math.min(elapsedTime / duration, 1);
                    const easedProgress = easeOutQuad(progress);
                    
                    const newZoom = startZoom + (targetZoom - startZoom) * easedProgress;
                    map.setZoom(newZoom, { animate: false });

                    updateTiles(); // Forcer la mise à jour des tuiles pendant l'animation

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                }

                requestAnimationFrame(animate);
            }

            // Gestionnaire d'événements pour le zoom
            let zoomDelta = 0;
            let zoomTimeout;

            map.on('wheel', function(e) {
                e.preventDefault();
                
                // Logique simplifiée pour le zoom
                zoomDelta += e.deltaY * -0.001;

                clearTimeout(zoomTimeout);
                zoomTimeout = setTimeout(function() {
                    if (Math.abs(zoomDelta) > 0.01) {
                        smoothZoom(map, zoomDelta, 200);
                    }
                    zoomDelta = 0;
                }, 50);
            });

            // Désactiver le zoom par défaut de Leaflet
            map.scrollWheelZoom.disable();

            // Ajout du gestionnaire d'événements pour le zoom tactile
            map.touchZoom.disable();
            map.on('touchstart', function(e) {
                if (e.touches.length !== 2) return;
                const touchStartDistance = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                
                const startZoom = map.getZoom();
                
                map.on('touchmove', function(e) {
                    if (e.touches.length !== 2) return;
                    const touchMoveDistance = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    
                    const zoomDelta = (touchMoveDistance - touchStartDistance) * 0.01;
                    smoothZoom(map, zoomDelta, 50);
                });
                
                map.on('touchend', function() {
                    map.off('touchmove');
                    map.off('touchend');
                });
            });
        });
    </script>
</body>
</html>